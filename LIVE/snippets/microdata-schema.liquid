{%- comment -%}
This snippet structures the micro-data using JSON-LD specification. Please note that for Product especially,
the schema often changes. We try to output as much info as possible, but Google may add new requirements over time,
or change the format of some info
{%- endcomment -%}

{%- if request.page_type == 'product' -%}
  {%- assign days_product_price_valid_until = 10 | times: 86400 -%}
  {% assign samitaLock = shop.metafields.lockAccess.listLocks.value %}

  {% assign samiProductID = product.id | append: "" %}
  {% assign productCollections = product.collections %}
  
  {% assign samitaLimitAll = "" %}
  {% assign samitaLimitAllPrice = "" %}
  {% assign samitaLimitAllAtc = "" %}
  
  {% assign samitaManualAll = "" %}
  {% assign samitaManualPrice = "" %}
  {% assign samitaManualAtc = "" %}
  
  {% assign samitaCollectionAll = "" %}
  {% assign samitaCollectionPrice = "" %}
  {% assign samitaCollectionAtc = "" %}
  
  {% for item in samitaLock -%}
    {% if item.status == 1 and item.resources_conditional.type[0] == "secret"  %}
      {% if item.resources_lock.limitProduct == "all" %}
              {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaSecAll = "samita_sec_p_all" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaSecPrice = "samita_sec_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaSecAtc = "samita_sec_p_atc" %}
                {% endif %}
              {% endfor %}
             {% assign lockid = 'sami_sec' %}
            {% endif %}
         {% if item.resources_lock.products contains samiProductID and item.resources_lock.type == "products" %}
           {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaSecAll = "samita_sec_p_all" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaSecPrice = "samita_sec_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaSecAtc = "samita_sec_p_atc" %}
                {% endif %}
              {% endfor %}
              {% assign lockid = 'sami_sec' %}
        {% endif %}
  
       {% if item.resources_lock.type == "collections" %}
          {% if productCollections.size > 0 %}
            {% for collection in productCollections %}
              {% assign colectionID = collection.id | append: "" %}
              {% if item.resources_lock.collections contains colectionID  %}
                  {% for lockRs in item.resources_lock.setting -%}
                  {% if lockRs == "all" %}
                  {% assign samitaSecAll = "samita_sec_p_all" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaSecPrice = "samita_sec_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaSecAtc = "samita_sec_p_atc" %}
                {% endif %}
                {% endfor %}
                 {% assign lockid = 'sami_sec' %}
              {% endif %}
            {% endfor %}
          {% endif %}
       {% endif %}
    {% endif %}
    {% if item.status == 1 and item.resources_conditional.type[0] == "passcode"  %}
       {% if item.resources_lock.limitProduct == "all" %}
              {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaPassAll = "samita_pass_p_all" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaPassPrice = "samita_pass_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaPassAtc = "samita_pass_p_atc" %}
                {% endif %}
              {% endfor %}
             {% assign lockid = 'passcode__' | append: item.id %}
            {% endif %}
         {% if item.resources_lock.products contains samiProductID and item.resources_lock.type == "products" %}
           {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaPassAll = "samita_pass_p_all" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaPassPrice = "samita_pass_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaPassAtc = "samita_pass_p_atc" %}
                {% endif %}
              {% endfor %}
             {% assign lockid = 'passcode__' | append: item.id %}
        {% endif %}
  
       {% if item.resources_lock.type == "collections" %}
          {% if productCollections.size > 0 %}
            {% for collection in productCollections %}
              {% assign colectionID = collection.id | append: "" %}
              {% if item.resources_lock.collections contains colectionID  %}
                  {% for lockRs in item.resources_lock.setting -%}
                  {% if lockRs == "all" %}
                    {% assign samitaPassCollecAll = "samita_pass_c_all" %}
                  {% endif %}
                  {% if lockRs == "price" %}
                    {% assign samitaPassCollecPrice = "samita_pass_c_price" %}
                  {% endif %}
                  {% if lockRs == "atc" %}
                    {% assign samitaPassCollecAtc = "samita_pass_c_atc" %}
                  {% endif %}
                {% endfor %}
                {% assign lockid = 'passcode__' | append: item.id %}
              {% endif %}
            {% endfor %}
          {% endif %}
       {% endif %}
    {% endif %}
    {% if item.status == 1 and item.resources_conditional.type[0] == "customers" %}
      {% if item.access == 1 %}
        {% if customer %}
          {% if item.resources_conditional.customer.source == "manual" %}
            {% if item.resources_lock.type == "collections" %}
              {% if productCollections.size > 0 %}
                {% for collection in productCollections %}
                {% assign colectionID = collection.id | append: "" %}
                  {% if item.resources_lock.collections contains colectionID  %}
                    {% assign samitaCus = true %}
                  {% for cus in item.resources_conditional.customer.listManual %}
                   {% if cus.id == customer.id %}
                     {% assign samitaCus = false %}
                     {% assign samitaLimitAll = "" %}
                      {% assign samitaLimitAllPrice = "" %}
                      {% assign samitaLimitAllAtc = "" %}
                      
                      {% assign samitaManualAll = "" %}
                      {% assign samitaManualPrice = "" %}
                      {% assign samitaManualAtc = "" %}
                      
                      {% assign samitaCollectionAll = "" %}
                      {% assign samitaCollectionPrice = "" %}
                      {% assign samitaCollectionAtc = "" %}
                   {% endif %}
                 {% endfor %}
                  {% if samitaCus %}
                      {% for lockRs in item.resources_lock.setting -%}
                      {% if lockRs == "all" %}
                        {% assign samitaManualAll = "samita_manual_p_all" %}
                      {% endif %}
                      {% if lockRs == "price" %}
                        {% assign samitaManualPrice = "samita_manual_p_price" %}
                      {% endif %}
                      {% if lockRs == "atc" %}
                        {% assign samitaManualAtc = "samita_manual_p_atc" %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
            {% if  item.resources_lock.type == "products"  %}
              {% if item.resources_lock.limitProduct == "all" %}
                {% assign samitaCus = true %}
                  {% for cus in item.resources_conditional.customer.listManual %}
                   {% if cus.id == customer.id %}
                     {% assign samitaCus = false %}
                     {% assign samitaLimitAll = "" %}
                      {% assign samitaLimitAllPrice = "" %}
                      {% assign samitaLimitAllAtc = "" %}
                      
                      {% assign samitaManualAll = "" %}
                      {% assign samitaManualPrice = "" %}
                      {% assign samitaManualAtc = "" %}
                      
                      {% assign samitaCollectionAll = "" %}
                      {% assign samitaCollectionPrice = "" %}
                      {% assign samitaCollectionAtc = "" %}
                   {% endif %}
                 {% endfor %}
                  {% if samitaCus %}
                      {% for lockRs in item.resources_lock.setting -%}
                      {% if lockRs == "all" %}
                        {% assign samitaManualAll = "samita_manual_p_all" %}
                      {% endif %}
                      {% if lockRs == "price" %}
                        {% assign samitaManualPrice = "samita_manual_p_price" %}
                      {% endif %}
                      {% if lockRs == "atc" %}
                        {% assign samitaManualAtc = "samita_manual_p_atc" %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
              {% else %}
                {% if item.resources_lock.products contains samiProductID %}
                  {% assign samitaCus = true %}
                  {% for cus in item.resources_conditional.customer.listManual %}
                   {% if cus.id == customer.id %}
                     {% assign samitaCus = false %}
                     {% assign samitaLimitAll = "" %}
                      {% assign samitaLimitAllPrice = "" %}
                      {% assign samitaLimitAllAtc = "" %}
                      
                      {% assign samitaManualAll = "" %}
                      {% assign samitaManualPrice = "" %}
                      {% assign samitaManualAtc = "" %}
                      
                      {% assign samitaCollectionAll = "" %}
                      {% assign samitaCollectionPrice = "" %}
                      {% assign samitaCollectionAtc = "" %}
                   {% endif %}
                 {% endfor %}
                  {% if samitaCus %}
                      {% for lockRs in item.resources_lock.setting -%}
                      {% if lockRs == "all" %}
                        {% assign samitaManualAll = "samita_manual_p_all" %}
                      {% endif %}
                      {% if lockRs == "price" %}
                        {% assign samitaManualPrice = "samita_manual_p_price" %}
                      {% endif %}
                      {% if lockRs == "atc" %}
                        {% assign samitaManualAtc = "samita_manual_p_atc" %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endif %}        
          {% endif %}
          {% if item.resources_conditional.customer.source == "rules" %}
            {% assign samitaNoTag = true %}
            {% for logic in item.resources_conditional.customer.logic[0] %}
              {% if logic.type == "tagged_with" %}
                {% if customer.tags contains logic.value %}
                  {% assign samitaNoTag = false %}
                  {% assign samitaLimitAll = "" %}
                  {% assign samitaLimitAllPrice = "" %}
                  {% assign samitaLimitAllAtc = "" %}
                  
                  {% assign samitaManualAll = "" %}
                  {% assign samitaManualPrice = "" %}
                  {% assign samitaManualAtc = "" %}
                  
                  {% assign samitaCollectionAll = "" %}
                  {% assign samitaCollectionPrice = "" %}
                  {% assign samitaCollectionAtc = "" %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {% if samitaNoTag %}
              {% if  item.resources_lock.type == "products"  %}
                {% if item.resources_lock.limitProduct == "all" %}
                  {% for lockRs in item.resources_lock.setting -%}
                    {% if lockRs == "all" %}
                      {% assign samitaLimitAll = "samita_all_p" %}
                    {% endif %}
                    {% if lockRs == "price" %}
                      {% assign samitaLimitAllPrice = "samita_all_p_price" %}
                    {% endif %}
                    {% if lockRs == "atc" %}
                      {% assign samitaLimitAllAtc = "samita_all_p_atc" %}
                    {% endif %}
                  {% endfor %}
                  {% else %}
                    {% if item.resources_lock.products contains samiProductID %}
                      {% for lockRs in item.resources_lock.setting -%}
                        {% if lockRs == "all" %}
                          {% assign samitaManualAll = "samita_manual_p_all" %}
                        {% endif %}
                        {% if lockRs == "price" %}
                          {% assign samitaManualPrice = "samita_manual_p_price" %}
                        {% endif %}
                        {% if lockRs == "atc" %}
                          {% assign samitaManualAtc = "samita_manual_p_atc" %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                {% endif %}
              {% endif %}
              {% if  item.resources_lock.type == "collections"  %}
                 {% if productCollections.size > 0 %}
                    {% for collection in productCollections %}
                      {% assign colectionID = collection.id | append: "" %}
                      {% if item.resources_lock.collections contains colectionID  %}
                          {% for lockRs in item.resources_lock.setting -%}
                            {% if lockRs == "all" %}
                              {% assign samitaCollectionAll = "samita_manual_c_all" %}
                            {% endif %}
                            {% if lockRs == "price" %}
                              {% assign samitaCollectionPrice = "samita_manual_c_price" %}
                            {% endif %}
                            {% if lockRs == "atc" %}
                                {% assign samitaCollectionAtc = "samita_manual_c_atc" %}
                            {% endif %}
                          {% endfor %}
                      {% endif %}
                    {% endfor %}
                  {% endif %}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endif %}
        {% unless customer %}
          {% if  item.resources_lock.type == "products"  %}
            {% if item.resources_lock.limitProduct == "all" %}
              {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaLimitAll = "samita_all_p" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaLimitAllPrice = "samita_all_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaLimitAllAtc = "samita_all_p_atc" %}
                {% endif %}
              {% endfor %}
              {% else %}
                {% if item.resources_lock.products contains samiProductID %}
                  {% for lockRs in item.resources_lock.setting -%}
                    {% if lockRs == "all" %}
                      {% assign samitaManualAll = "samita_manual_p_all" %}
                    {% endif %}
                    {% if lockRs == "price" %}
                      {% assign samitaManualPrice = "samita_manual_p_price" %}
                    {% endif %}
                    {% if lockRs == "atc" %}
                      {% assign samitaManualAtc = "samita_manual_p_atc" %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
            {% endif %}
          {% endif %}
          {% if  item.resources_lock.type == "collections"  %}
             {% if productCollections.size > 0 %}
                {% for collection in productCollections %}
                  {% assign colectionID = collection.id | append: "" %}
                  {% if item.resources_lock.collections contains colectionID  %}
                      {% for lockRs in item.resources_lock.setting -%}
                        {% if lockRs == "all" %}
                          {% assign samitaCollectionAll = "samita_manual_c_all" %}
                        {% endif %}
                        {% if lockRs == "price" %}
                          {% assign samitaCollectionPrice = "samita_manual_c_price" %}
                        {% endif %}
                        {% if lockRs == "atc" %}
                            {% assign samitaCollectionAtc = "samita_manual_c_atc" %}
                        {% endif %}
                      {% endfor %}
                  {% endif %}
                {% endfor %}
              {% endif %}
          {% endif %}
        {% endunless %}
      {% endif %}
    {% endif %}
    
    {% if item.status == 1 and item.resources_conditional.type[0] == "logged" %}
      {% if item.access == 1 %}
        {% unless customer %}
          {% if  item.resources_lock.type == "products"  %}
            {% if item.resources_lock.limitProduct == "all" %}
              {% for lockRs in item.resources_lock.setting -%}
                {% if lockRs == "all" %}
                  {% assign samitaLimitAll = "samita_all_p" %}
                {% endif %}
                {% if lockRs == "price" %}
                  {% assign samitaLimitAllPrice = "samita_all_p_price" %}
                {% endif %}
                {% if lockRs == "atc" %}
                  {% assign samitaLimitAllAtc = "samita_all_p_atc" %}
                {% endif %}
              {% endfor %}
              {% else %}
                {% if item.resources_lock.products contains samiProductID %}
                  {% for lockRs in item.resources_lock.setting -%}
                    {% if lockRs == "all" %}
                      {% assign samitaManualAll = "samita_manual_p_all" %}
                    {% endif %}
                    {% if lockRs == "price" %}
                      {% assign samitaManualPrice = "samita_manual_p_price" %}
                    {% endif %}
                    {% if lockRs == "atc" %}
                      {% assign samitaManualAtc = "samita_manual_p_atc" %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
            {% endif %}
          {% endif %}
          {% if  item.resources_lock.type == "collections"  %}
             {% if productCollections.size > 0 %}
                {% for collection in productCollections %}
                  {% assign colectionID = collection.id | append: "" %}
                  {% if item.resources_lock.collections contains colectionID  %}
                      {% for lockRs in item.resources_lock.setting -%}
                        {% if lockRs == "all" %}
                          {% assign samitaCollectionAll = "samita_manual_c_all" %}
                        {% endif %}
                        {% if lockRs == "price" %}
                          {% assign samitaCollectionPrice = "samita_manual_c_price" %}
                        {% endif %}
                        {% if lockRs == "atc" %}
                            {% assign samitaCollectionAtc = "samita_manual_c_atc" %}
                        {% endif %}
                      {% endfor %}
                  {% endif %}
                {% endfor %}
              {% endif %}
          {% endif %}
        {% endunless %}
      {% endif %}
    {% endif %}
  {%- endfor %}

  {% assign samiShowPrice = true %}
  {% if samitaPassPrice == "samita_pass_p_price" or samitaPassCollecPrice == "samita_pass_c_price" or samitaLimitAllPrice == "samita_all_p_price" or samitaManualPrice == "samita_manual_p_price" or samitaCollectionPrice == "samita_manual_c_price"  %}
     {% assign samiShowPrice = false %}
  {% endif %}



  {%- capture main_entity_microdata -%}
    "@type": "Product",
    "productID": {{ product.id | json }},
    "offers": [
      {%- for variant in product.variants -%}
        {%- assign gtin_option = 'gtin' -%}
        {%- if variant.barcode != blank -%}
          {%- assign is_barcode_available = true -%}
          {%- assign gtin_string_length = variant.barcode | size -%}

          {%- if gtin_string_length == 8 or gtin_string_length == 12 or gtin_string_length == 13 or gtin_string_length == 14 -%}
            {%- assign is_valid_gtin_length = true -%}
            {%- assign gtin_option = gtin_option | append: gtin_string_length -%}
          {%- endif -%}
        {%- endif -%}

        {
          "@type": "Offer",
          "name": {{ variant.title | json }},
          "availability": {%- if variant.available -%}"https://schema.org/InStock"{%- else -%}"https://schema.org/OutOfStock"{%- endif -%},
          {% if samiShowPrice %}"price": {{ variant.price | divided_by: 100.0 | json }},
          "priceCurrency": {{ cart.currency.iso_code | json }},{% endif %}
          "priceValidUntil": "{{ 'now' | date: '%s' | plus: days_product_price_valid_until | date: '%Y-%m-%d' }}",
          {%- if variant.sku != blank -%}
            "sku": {{ variant.sku | json }},
          {%- endif -%}
          {%- if is_barcode_available and is_valid_gtin_length %}
            "{{ gtin_option }}": {{ product.selected_or_first_available_variant.barcode | json }},
          {%- elsif is_barcode_available %}
            "mpn": {{ product.selected_or_first_available_variant.barcode | json }},
          {%- endif %}
          "url": "{{ product.url }}?variant={{ variant.id }}"
        }{% unless forloop.last %},{% endunless %}
      {%- endfor -%}
    ],
    {%- if product.metafields.reviews.rating.value != blank and product.metafields.reviews.rating_count.value > 0 -%}
      "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "{{ product.metafields.reviews.rating.value }}",
        "reviewCount": "{{ product.metafields.reviews.rating_count.value }}",
        "worstRating": "{{ product.metafields.reviews.rating.value.scale_min }}",
        "bestRating": "{{ product.metafields.reviews.rating.value.scale_max }}"
      },
    {%- endif -%}
    "brand": {
      "@type": "Brand",
      "name": {{ product.vendor | json }}
    },
    "name": {{ product.title | json }},
    "description": {{ product.description | strip_html | json }},
    "category": {{ product.type | json }},
    "url": "{{ product.url }}",
    "sku": {{ product.selected_or_first_available_variant.sku | json }},
    "image": {
      "@type": "ImageObject",
      "url": "https:{{ page_image | image_url: width: 1024 }}",
      "image": "https:{{ page_image | image_url: width: 1024 }}",
      "name": {{ page_image.alt | json }},
      "width": "1024",
      "height": "1024"
    }
  {%- endcapture -%}
{%- elsif request.page_type == 'article' -%}
  {%- capture main_entity_microdata -%}
    "@type": "BlogPosting",
    "mainEntityOfPage": "{{ article.url }}",
    "articleSection": {{ blog.title | json }},
    "keywords": "{{ article.tags | join: ', ' }}",
    "headline": {{ article.title | json }},
    "description": {{ article.excerpt_or_content | strip_html | truncatewords: 25 | json }},
    "dateCreated": "{{ article.created_at | date: '%Y-%m-%dT%T' }}",
    "datePublished": "{{ article.published_at | date: '%Y-%m-%dT%T' }}",
    "dateModified": "{{ article.published_at | date: '%Y-%m-%dT%T' }}",
    "image": {
      "@type": "ImageObject",
      "url": "https:{{ page_image | image_url: width: 1024 }}",
      "image": "https:{{ page_image | image_url: width: 1024 }}",
      "name": {{ page_image.alt | json }},
      "width": "1024",
      "height": "1024"
    },
    "author": {
      "@type": "Person",
      "name": "{{ article.user.first_name | escape }} {{ article.user.last_name | escape }}",
      "givenName": {{ article.user.first_name | json }},
      "familyName": {{ article.user.last_name | json }}
    },
    "publisher": {
      "@type": "Organization",
      "name": {{ shop.name | json }}
    },
    "commentCount": {{ article.comments_count }},
    "comment": [
      {%- for comment in article.comments limit: 5 -%}
        {
          "@type": "Comment",
          "author": {{ comment.author | json }},
          "datePublished": "{{ comment.created_at | date: '%Y-%m-%dT%T' }}",
          "text": {{ comment.content | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
    ]
  {%- endcapture -%}
{%- endif -%}


{% if main_entity_microdata != blank %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    {{ main_entity_microdata }}
  }
  </script>
{% endif %}

{% if breadcrumb_entity_microdata != blank %}
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    {{ breadcrumb_entity_microdata }}
  }
  </script>
{% endif %}

{%- if request.page_type == 'index' -%}
  {%- assign potential_action_target = request.origin | append: routes.search_url | append: "?q={search_term_string}" -%}

  <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebSite",
      "name": {{ shop.name | json }},
      "url": {{ shop.url | append: page.url | json }},
      "potentialAction": {
        "@type": "SearchAction",
        "target": {{ potential_action_target | json }},
        "query-input": "required name=search_term_string"
      }
    }
  </script>
{%- endif -%}